import { useEffect, useState } from 'react';

/**
 * –•—É–∫ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ URL (Blob URL) –¥–ª—è —Ñ–∞–π–ª–∞ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º –ø–∞–º—è—Ç—å—é.
 *
 * -----------------------------------------------------------------------------
 * üìñ –ò–ù–°–¢–†–£–ö–¶–ò–Ø –ü–û –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Æ
 * -----------------------------------------------------------------------------
 *
 * 1. –ó–ê–ß–ï–ú –≠–¢–û –ù–£–ñ–ù–û:
 *    –ú–µ—Ç–æ–¥ `URL.createObjectURL(file)` –≤—ã–¥–µ–ª—è–µ—Ç –ø–∞–º—è—Ç—å –≤ –±—Ä–∞—É–∑–µ—Ä–µ, –∫–æ—Ç–æ—Ä–∞—è
 *    –ù–ï –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–±–æ—Ä—â–∏–∫–æ–º –º—É—Å–æ—Ä–∞, –¥–∞–∂–µ –µ—Å–ª–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç —É–¥–∞–ª–µ–Ω.
 *    –ï—Å–ª–∏ –Ω–µ –≤—ã–∑—ã–≤–∞—Ç—å `URL.revokeObjectURL()`, —ç—Ç–æ –ø—Ä–∏–≤–µ–¥–µ—Ç –∫ —É—Ç–µ—á–∫–µ –ø–∞–º—è—Ç–∏ (Memory Leak),
 *    –æ—Å–æ–±–µ–Ω–Ω–æ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –≤–∏–¥–µ–æ –∏–ª–∏ –±–æ–ª—å—à–∏–º–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏.
 *
 * 2. –ö–ê–ö –≠–¢–û –†–ê–ë–û–¢–ê–ï–¢:
 *    –≠—Ç–æ—Ç —Ö—É–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–∑—ã–≤–∞–µ—Ç `createObjectURL` –ø—Ä–∏ –ø–æ—è–≤–ª–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞
 *    –∏ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –≤—ã–∑—ã–≤–∞–µ—Ç `revokeObjectURL` –ø—Ä–∏:
 *    - –ò–∑–º–µ–Ω–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞ (—Å–º–µ–Ω–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏).
 *    - –†–∞–∑–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ (—É—Ö–æ–¥–µ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã).
 *
 * 3. –ü–†–ò–ú–ï–†:
 *    const [file, setFile] = useState<File | null>(null);
 *    // –ë–µ–∑–æ–ø–∞—Å–Ω–æ –ø–æ–ª—É—á–∞–µ–º URL. –ï—Å–ª–∏ file === null, –≤–µ—Ä–Ω–µ—Ç—Å—è null.
 *    const previewUrl = useObjectUrl(file);
 *
 *    return (
 *      <div>
 *        <input type="file" onChange={e => setFile(e.target.files?.[0])} />
 *        {previewUrl && <img src={previewUrl} alt="Preview" />}
 *      </div>
 *    );
 * -----------------------------------------------------------------------------
 */
export function useObjectUrl(file: File | null | undefined): string | null {
  const [url, setUrl] = useState<string | null>(null);

  useEffect(() => {
    // 1. –í—ã—á–∏—Å–ª—è–µ–º URL –∏–ª–∏ null.
    const objectUrl = file ? URL.createObjectURL(file) : null;

    // 2. –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–µ–π—Ç.
    // –ú—ã –≤—ã–Ω—É–∂–¥–µ–Ω—ã –≤—ã–∑–≤–∞—Ç—å setState –≤–Ω—É—Ç—Ä–∏ useEffect, —Ç–∞–∫ –∫–∞–∫ createObjectURL
    // —è–≤–ª—è–µ—Ç—Å—è –ø–æ–±–æ—á–Ω—ã–º —ç—Ñ—Ñ–µ–∫—Ç–æ–º. –≠—Ç–æ –≤—ã–∑–æ–≤–µ—Ç —Ä–µ-—Ä–µ–Ω–¥–µ—Ä, —á—Ç–æ –æ–∂–∏–¥–∞–µ–º–æ.
    // eslint-disable-next-line react-hooks/set-state-in-effect
    setUrl(objectUrl);

    // 3. Cleanup: –û—á–∏—â–∞–µ–º –ø–∞–º—è—Ç—å, –µ—Å–ª–∏ URL –±—ã–ª —Å–æ–∑–¥–∞–Ω.
    return () => {
      if (objectUrl) {
        URL.revokeObjectURL(objectUrl);
      }
    };
  }, [file]);

  return url;
}
